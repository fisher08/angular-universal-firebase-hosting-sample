"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
require("zone.js/dist/zone-node");
var core_1 = require("@angular/core");
var platform_server_1 = require("@angular/platform-server");
var fs = require("fs");
var rxjs_1 = require("rxjs");
/**
 * Create a single observable of a file system read
 * @param file the file path to read
 */
function readFile$(file) {
    return rxjs_1.Observable.create(function (observer) {
        fs.readFile(file, 'utf8', function (err, data) {
            if (err) {
                observer.error(err);
            }
            else {
                observer.next(data);
                observer.complete();
            }
        });
    });
}
/**
 * Create the Angular Universal request handler
 * @param config
 */
function angularUniversal(_a) {
    var index = _a.index, main = _a.main, staticDirectory = _a.staticDirectory, _b = _a.enableProdMode, enableProdMode = _b === void 0 ? false : _b;
    if (enableProdMode) {
        core_1.enableProdMode();
    }
    return function (req, res) {
        readFile$(index)
            .mergeMap(function (document) {
            var url = req.path;
            var AppServerModuleNgFactory = require(main).AppServerModuleNgFactory;
            return rxjs_1.Observable.from(platform_server_1.renderModuleFactory(AppServerModuleNgFactory, { document: document, url: url }));
        })
            .take(1)
            .subscribe(function (html) { res.send(html); });
    };
}
exports.angularUniversal = angularUniversal;
//# sourceMappingURL=index.js.map